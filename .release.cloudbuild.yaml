steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['pull', 'gcr.io/$PROJECT_ID/frontend:$COMMIT_SHA']
  id:   'pullFrontend'
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/frontend:$COMMIT_SHA', 'gcr.io/$PROJECT_ID/frontend:$TAG_NAME']
  id:   'tagFrontend'
  waitFor: ['pullFrontend']

- name: 'gcr.io/cloud-builders/docker'
  args: ['pull', 'gcr.io/$PROJECT_ID/api-server:$COMMIT_SHA']
  id:   'pullAPIServer'
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/api-server:$COMMIT_SHA', 'gcr.io/$PROJECT_ID/api-server:$TAG_NAME']
  id:   'tagAPIServer'
  waitFor: ['pullAPIServer']

- name: 'gcr.io/cloud-builders/docker'
  args: ['pull', 'gcr.io/$PROJECT_ID/scheduledworkflow:$COMMIT_SHA']
  id:   'pullScheduledworkflow'
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/scheduledworkflow:$COMMIT_SHA', 'gcr.io/$PROJECT_ID/scheduledworkflow:$TAG_NAME']
  id:   'tagScheduledworkflow'
  waitFor: ['pullScheduledworkflow']

- name: 'gcr.io/cloud-builders/docker'
  args: ['pull', 'gcr.io/$PROJECT_ID/persistenceagent:$COMMIT_SHA']
  id:   'pullPersistenceagent'
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/persistenceagent:$COMMIT_SHA', 'gcr.io/$PROJECT_ID/persistenceagent:$TAG_NAME']
  id:   'tagPersistenceagent'
  waitFor: ['pullPersistenceagent']

- name: 'gcr.io/cloud-builders/docker'
  args: ['pull', 'gcr.io/$PROJECT_ID/bootstrapper:$COMMIT_SHA']
  id:   'pullBootstrapper'
- name: 'gcr.io/cloud-builders/docker'
  args: ['tag', 'gcr.io/$PROJECT_ID/bootstrapper:$COMMIT_SHA', 'gcr.io/$PROJECT_ID/bootstrapper:$TAG_NAME']
  id:   'tagBootstrapper'
  waitFor: ['pullBootstrapper']

- name: 'debian'
  entrypoint: '/bin/bash'
  args: ['-c', 'sed -i -e "s/gcr.io\/ml-pipeline\/bootstrapper:\([a-zA-Z0-9_.-]\)\+/gcr.io\/ml-pipeline\/bootstrapper:$TAG_NAME/g" /workspace/bootstrapper.yaml']
  id:   'prepareBootstrapperYAML'
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', '/workspace/bootstrapper.yaml', 'gs://$PROJECT_ID/release/$TAG_NAME/bootstrapper.yaml']
  id:   'copyBootstrapperYAML'
  waitFor: ['prepareBootstrapperYAML']
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', '/workspace/bootstrapper.yaml', 'gs://$PROJECT_ID/release/latest/bootstrapper.yaml']
  id:   'copyBootstrapperYAMLToLatest'
  waitFor: ['prepareBootstrapperYAML']

images:
- 'gcr.io/$PROJECT_ID/frontend:$TAG_NAME'
- 'gcr.io/$PROJECT_ID/api-server:$TAG_NAME'
- 'gcr.io/$PROJECT_ID/scheduledworkflow:$TAG_NAME'
- 'gcr.io/$PROJECT_ID/persistenceagent:$TAG_NAME'
- 'gcr.io/$PROJECT_ID/bootstrapper:$TAG_NAME'

timeout: '600s'
