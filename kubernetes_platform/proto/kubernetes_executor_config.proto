// Copyright 2023 The Kubeflow Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package kfp_kubernetes;

import "google/protobuf/struct.proto";

option go_package = "github.com/kubeflow/pipelines/kubernetes_platform/proto/go";

message KubernetesExecutorConfig {
    repeated SecretAsVolume secret_as_volume = 1;
    repeated SecretAsEnv secret_as_env = 2;
    repeated PvcMount pvc_mount = 3;
}

message SecretAsVolume {
    // name of the Secret
    string secret_name = 1;
    // container path to mount the Secret data
    string mount_path = 2;
}

message SecretAsEnv {
    // name of the Secret
    string secret_name = 1;

    message SecretKeyToEnvMap {
        // corresponds to a key of the Secret.data field
        string secret_key = 1;
        // env var to which secret_key's data should be set
        string env_var = 2;
    }

    repeated SecretKeyToEnvMap key_to_env = 2;
}

// Represents an upstream task's output parameter.
message TaskOutputParameterSpec {
    // The name of the upstream task which produces the output parameter that
    // matches with the `output_parameter_key`.
    string producer_task = 1;

    // The key of [TaskOutputsSpec.parameters][] map of the producer task.
    string output_parameter_key = 2;
}

message PvcMount {
    // identifier for the PVC
    // used like TaskInputsSpec.InputParameterSpec.kind
    oneof pvc_reference {
        // output parameter from an upstream task
        TaskOutputParameterSpec task_output_parameter = 1;
        // a constant value
        string constant = 2;
        // pass the input parameter from parent component input parameter
        string component_input_parameter = 3;
    }
    // container path to which the PVC should be mounted
    string mount_path = 4;
}

message CreatePvc {
    oneof name {
        // name of the PVC, if not dynamically generated
        string pvc_name = 1;
        // suffix for a dynamically generated PVC name of the form
        // {{workflow.name}}-<pvc_name_suffix>
        string pvc_name_suffix = 2;
    }
    // corresponds to PersistentVolumeClaim.spec.accessMode field
    repeated string access_modes = 3;
    // corresponds to PersistentVolumeClaim.spec.resources.requests.storage field
    string size = 4;
    // if true, corresponds to omitted PersistentVolumeClaim.spec.storageClassName
    bool default_storage_class = 5;
    // corresponds to PersistentVolumeClaim.spec.storageClassName string field
    // should only be used if default_storage_class is false
    string storage_class = 6;
    // corresponds to PersistentVolumeClaim.spec.volumeName field
    string volume_name = 7;
    // corresponds to PersistentVolumeClaim.metadata.annotations field
    google.protobuf.Struct annotations = 8;
}

message DeletePvc {
    // identifier for the PVC
    // used like TaskInputsSpec.InputParameterSpec.kind
    oneof pvc_reference {
        // output parameter from an upstream task
        TaskOutputParameterSpec task_output_parameter = 1;
        // a constant value
        string constant = 2;
        // pass the input parameter from parent component input parameter
        string component_input_parameter = 3;
    }
}
