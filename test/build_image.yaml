# Copyright 2018 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: build-image-
spec:
  entrypoint: build-image
  arguments:
    parameters:
    - name: commit-sha
      value: master
    - name: cleanup
      value: true
    - name: bootstrapper-image-suffix
      value: bootstrapper
    - name: api-image-suffix
      value: api
    - name: frontend-image-suffix
      value: frontend
    - name: scheduledworkflow-image-suffix
      value: scheduledworkflow
    - name: persistenceagent-image-suffix
      value: persistenceagent
  templates:
  - name: build-image
    inputs:
      parameters:
      - name: commit-sha
      - name: bootstrapper-image-suffix
      - name: api-image-suffix
      - name: frontend-image-suffix
      - name: scheduledworkflow-image-suffix
      - name: persistenceagent-image-suffix
    steps:
    - - name: get-project
        template: get-project
    - - name: build-bootstrapper-image
        template: build-image
        arguments:
          parameters:
          - name: project
            value: "{{steps.get-project.outputs.result}}"
          - name: commit-sha
            value: "{{inputs.parameters.commit-sha}}"
          - name: docker-path
            value: ml-pipeline
          - name: image-suffix
            value: "{{inputs.parameters.bootstrapper-image-suffix}}"
      - name: build-api-server-image
        template: build-image
        arguments:
          parameters:
          - name: project
            value: "{{steps.get-project.outputs.result}}"
          - name: commit-sha
            value: "{{inputs.parameters.commit-sha}}"
          - name: docker-path
            value: backend
          - name: image-suffix
            value: "{{inputs.parameters.api-image-suffix}}"
      - name: build-frontend-image
        template: build-image
        arguments:
          parameters:
          - name: project
            value: "{{steps.get-project.outputs.result}}"
          - name: commit-sha
            value: "{{inputs.parameters.commit-sha}}"
          - name: docker-path
            value: frontend
          - name: image-suffix
            value: "{{inputs.parameters.frontend-image-suffix}}"
      - name: build-scheduledworkflow-image
        template: build-image
        arguments:
          parameters:
          - name: project
            value: "{{steps.get-project.outputs.result}}"
          - name: commit-sha
            value: "{{inputs.parameters.commit-sha}}"
          - name: docker-path
            value: backend
          - name: image-suffix
            value: "{{inputs.parameters.scheduledworkflow-image-suffix}}"
          - name: docker-file
            value: Dockerfile.scheduledworkflow
      - name: build-persistenceagent-image
        template: build-image
        arguments:
          parameters:
          - name: project
            value: "{{steps.get-project.outputs.result}}"
          - name: commit-sha
            value: "{{inputs.parameters.commit-sha}}"
          - name: docker-path
            value: backend
          - name: image-suffix
            value: "{{inputs.parameters.persistenceagent-image-suffix}}"
          - name: docker-file
            value: Dockerfile.persistenceagent

  - name: get-project
    script:
      image: google/cloud-sdk
      command: [bash]
      source: |
        gcloud config config-helper --format "value(configuration.properties.core.project)"

  # Build image and upload to GCR in the specified project
  - name: build-image
    inputs:
      parameters:
      # The project that image deployed to
      - name: project
      # The github commit-sha to pull code from
      - name: commit-sha
      # The relative code path to the Dockerfile
      - name: docker-path
      # Name of the Docker file to use. "Dockerfile" by default
      - name: docker-file
        value: Dockerfile
      - name: image-suffix
    container:
      image: gcr.io/ml-pipeline/image-builder:v20180724-0.0.10-60-g2d7875a-e3b0c4
      imagePullPolicy: 'Always'
      args: [
        "--commit_sha", "{{inputs.parameters.commit-sha}}",
        "--docker_path", "{{inputs.parameters.docker-path}}",
        "--docker_file", "{{inputs.parameters.docker-file}}",
        "--image_name", "gcr.io/{{inputs.parameters.project}}/{{inputs.parameters.commit-sha}}/{{inputs.parameters.image-suffix}}",
      ]
      volumeMounts:
      - name: secret-volume
        mountPath: "/root/.ssh/github"
      env:
      - name: DOCKER_HOST
        value: 127.0.0.1
    sidecars:
    - name: dind
      image: docker:17.10-dind
      securityContext:
        privileged: true
      mirrorVolumeMounts: true

  volumes:
  - name: secret-volume
    secret:
      defaultMode: 256
      secretName: ssh-key-secret
