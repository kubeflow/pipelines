name: Build and Push for Release
on:
  workflow_dispatch:
    inputs:
      src_branch:
        type: string
        default: 'release-X.Y'
        description: 'Source branch to build KFP from'
        required: true
      target_tag:
        type: string
        default: 'X.Y.Z'
        description: 'Target Image Tag'
        required: true
      overwrite_imgs:
        type: string
        default: 'true'
        description: 'Overwrite images in GHCR if they already exist for this tag.'
        required: true
      set_latest:
        type: string
        default: 'true'
        description: 'Set latest tag on build images.'
        required: true
      add_sha_tag:
        type: string
        default: 'true'
        description: 'Add a sha image tag.'
        required: false
      dry_run:
        type: boolean
        default: false
        description: 'Dry run mode - build images without pushing to registry or creating tags.'
        required: false
jobs:
  build-images-for-release:
    strategy:
      fail-fast: true
      matrix:
        include:
          - image: kfp-api-server
            dockerfile: backend/Dockerfile
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-frontend
            dockerfile: frontend/Dockerfile
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-persistence-agent
            dockerfile: backend/Dockerfile.persistenceagent
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-scheduled-workflow-controller
            dockerfile: backend/Dockerfile.scheduledworkflow
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-viewer-crd-controller
            dockerfile: backend/Dockerfile.viewercontroller
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-visualization-server
            dockerfile: backend/Dockerfile.visualization
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-launcher
            dockerfile: backend/Dockerfile.launcher
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-driver
            dockerfile: backend/Dockerfile.driver
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-cache-deployer
            dockerfile: backend/src/cache/deployer/Dockerfile
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-cache-server
            dockerfile: backend/Dockerfile.cacheserver
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-metadata-writer
            dockerfile: backend/metadata_writer/Dockerfile
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-metadata-envoy
            dockerfile: third_party/metadata_envoy/Dockerfile
            context: .
            platforms: 'linux/amd64,linux/arm64'
          - image: kfp-inverse-proxy-agent
            dockerfile: proxy/Dockerfile
            context: ./proxy
            platforms: 'linux/amd64'  # base image is amd64-only
    uses: ./.github/workflows/build-and-push.yml
    with:
      src_branch: ${{ inputs.src_branch }}
      target_tag: ${{ inputs.target_tag }}
      overwrite_imgs: ${{ inputs.overwrite_imgs }}
      set_latest: ${{ inputs.set_latest }}
      add_sha_tag: ${{ inputs.add_sha_tag }}
      app_to_build: ${{ matrix.image }}
      image_context: ${{ matrix.context }}
      docker_file: ${{ matrix.dockerfile }}
      platforms: ${{ matrix.platforms }}
      push: ${{ !inputs.dry_run }}
