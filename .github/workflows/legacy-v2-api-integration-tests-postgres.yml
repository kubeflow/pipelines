name: KFP API Integration V2 (Legacy) - PostgreSQL

on:
  push:
    branches: [master]
  pull_request:
    paths:
      - ".github/workflows/legacy-v2-api-integration-tests-postgres.yml"
      - ".github/resources/**"
      - "backend/**"
      - "manifests/kustomize/third-party/postgresql/**"
      - "!**/*.md"
      - "!**/OWNERS"

concurrency:
  group: legacy-integration-v2-tests-postgres-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NAMESPACE: kubeflow
  POSTGRES_NAMESPACE: kubeflow
  DB_TYPE: postgres
  DB_DRIVER: pgx
  DB_PORT: "5432"
  DB_USER: user
  DB_PASSWORD: password
  DB_NAME: mlpipeline
jobs:
  build:
    uses: ./.github/workflows/image-builds-with-cache.yml
  postgres-pgx:
    runs-on: ubuntu-latest
    needs: build
    continue-on-error: false
    strategy:
      matrix:
        pipeline_store: ["database", "kubernetes"]
        k8s_version: ["v1.34.0"]
        pod_to_pod_tls_enabled: [true, false]
        cache_enabled: [true, false]
        exclude:
          - pipeline_store: "kubernetes"
            pod_to_pod_tls_enabled: true
      fail-fast: false # Ensure all jobs in the matrix run, even if one fails
    name: API v2 - PG - K8s ${{ matrix.k8s_version }} - Store ${{ matrix.pipeline_store }} - TLS ${{ matrix.pod_to_pod_tls_enabled }} - Cache ${{ matrix.cache_enabled }}

    steps:
      - name: Checkout target code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Create KFP cluster
        uses: ./.github/actions/create-cluster
        with:
          k8s_version: ${{ matrix.k8s_version }}

      - name: Deploy KFP with Postgres
        uses: ./.github/actions/deploy
        with:
          db_type: "pgx"
          pipeline_store: ${{ matrix.pipeline_store }}
          cache_enabled: ${{ matrix.cache_enabled }}
          pod_to_pod_tls_enabled: ${{ matrix.pod_to_pod_tls_enabled }}
          image_path: ${{ needs.build.outputs.IMAGE_PATH }}
          image_tag: ${{ needs.build.outputs.IMAGE_TAG }}
          image_registry: ${{ needs.build.outputs.IMAGE_REGISTRY }}
          forward_port: "true"
      - name: Port-forward Postgres
        run: kubectl -n "$POSTGRES_NAMESPACE" port-forward svc/postgres-service ${{ env.DB_PORT }}:${{ env.DB_PORT }} &

      - name: Port-forward ML Metadata service
        run: kubectl -n "$NAMESPACE" port-forward svc/metadata-grpc-service 8080:8080 &

      - name: Extract CA certificate for TLS
        if: matrix.pod_to_pod_tls_enabled == true
        run: |
          kubectl wait --for=jsonpath='{.data.ca\.crt}' --timeout=300s secret/kfp-api-tls-cert -n "$NAMESPACE"
          kubectl get secret kfp-api-tls-cert -n "$NAMESPACE" -o jsonpath='{.data.ca\.crt}' | base64 -d > "${{ github.workspace }}/ca.crt"
          echo "CA_CERT_PATH=${{ github.workspace }}/ca.crt" >> "$GITHUB_ENV"

      - name: Run v2 integration tests
        run: |
          # v2/integration tests use testify/suite framework, not Ginkgo, so we must use 'go test' instead of 'ginkgo'
          # Build the go test command with appropriate flags
          TEST_CMD="go test -v -timeout 30m ./backend/test/v2/integration/..."

          # Arguments for the test binary (passed after -args)
          TEST_ARGS="-runIntegrationTests=true -namespace=$NAMESPACE -cacheEnabled=${{ matrix.cache_enabled }} -repoName=${{ github.repository }} -branchName=${{ github.ref_name }} -tlsEnabled=${{ matrix.pod_to_pod_tls_enabled }} -caCertPath=$CA_CERT_PATH"

          if [[ "${{ matrix.cache_enabled }}" == "false" ]]; then
            # When cache is disabled, we must skip the cache test itself.
            # Use Go test's -skip flag to exclude TestCache
            TEST_CMD="$TEST_CMD -skip TestCache"
          fi

          # Execute the test command with arguments
          eval "$TEST_CMD -args $TEST_ARGS"
        env:
          PULL_NUMBER: ${{ github.event.pull_request.number }}
          PIPELINE_STORE: ${{ matrix.pipeline_store }}

      - name: Collect pod logs
        if: always()
        run: |
          mkdir -p /tmp/tmp.kfp /tmp/tmp.postgres
          ./.github/resources/scripts/collect-logs.sh --ns "$NAMESPACE" --output /tmp/tmp.kfp/pod_log.txt
          ./.github/resources/scripts/collect-logs.sh --ns "$POSTGRES_NAMESPACE" --output /tmp/tmp.postgres/pod_log.txt

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kfp-api-v2-pg-k8s-${{ matrix.k8s_version }}-${{ matrix.pipeline_store }}-tls-${{ matrix.pod_to_pod_tls_enabled }}-cache-${{ matrix.cache_enabled }}
          path: /tmp/tmp*/*
