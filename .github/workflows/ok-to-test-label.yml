name: /ok-to-test -> label

# When a maintainer comments /ok-to-test, this adds the 'ok-to-test' label.
# The ok-to-test-ci.yml workflow then automatically executes CI for labeled PRs.

# Please note, the google-oss-prow bot also converts /ok-to-test comments to
# labels. As a result, this is technically redundant, but I'm adding it in case
# we decide to move away from prow.

on:
  issue_comment:
    types:
      - created

permissions: read-all

jobs:
  # Notify non-members that they cannot use privileged commands
  unauthorized:
    runs-on: ubuntu-latest
    if: >-
      contains(github.event.comment.body, '/ok-to-test') &&
      !(github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'OWNER')
    permissions:
      issues: write
    steps:
      - name: Notify commenter of insufficient permissions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: |
            ðŸš« This command cannot be processed. Only organization members or owners can use `/ok-to-test`.
            Once a maintainer applies the `ok-to-test` label, CI will run automatically on all future commits.
        run: |
          gh issue comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --body "${MESSAGE}"

  # Add ok-to-test label when a maintainer comments /ok-to-test
  ok-to-test:
    runs-on: ubuntu-latest
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ok-to-test') &&
      (github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'OWNER')
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Add ok-to-test label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit "${{ github.event.issue.number }}" \
            --repo "${{ github.repository }}" \
            --add-label "ok-to-test"

          gh issue comment "${{ github.event.issue.number }}" \
            --repo "${{ github.repository }}" \
            --body "âœ… Added \`ok-to-test\` label. CI will now run automatically on all commits to this PR."
