name: Publish Python Packages
on:
  workflow_dispatch:
    inputs:
      tag:
        type: string
        required: true
        description: "Tag associated with the release (e.g.: 2.14.0)"
      packages:
        type: choice
        required: true
        description: "Which package(s) to publish"
        options:
          - all
          - kfp-pipeline-spec
          - kfp-server-api
          - kfp
          - kfp-kubernetes
      dry_run:
        type: boolean
        required: true
        default: true
        description: "Dry run - build packages without publishing to PyPI"

jobs:
  publish-kfp-pipeline-spec:
    if: ${{ github.event.inputs.packages == 'all' || github.event.inputs.packages == 'kfp-pipeline-spec' }}
    uses: ./.github/workflows/publish-package-reusable.yml
    with:
      package_name: kfp-pipeline-spec
      build_dir: api
      dist_path: api/v2alpha1/python/dist/
      build_commands: |
        make python
        cd v2alpha1/python
        twine check dist/*
      tag: ${{ github.event.inputs.tag }}
      dry_run: ${{ github.event.inputs.dry_run == 'true' }}

  publish-kfp-server-api:
    if: ${{ github.event.inputs.packages == 'all' || github.event.inputs.packages == 'kfp-server-api' }}
    uses: ./.github/workflows/publish-package-reusable.yml
    with:
      package_name: kfp-server-api
      build_dir: backend/api/v2beta1/python_http_client
      dist_path: backend/api/v2beta1/python_http_client/dist/
      build_commands: |
        rm -rf dist
        python setup.py --quiet sdist
        twine check dist/*
      tag: ${{ github.event.inputs.tag }}
      dry_run: ${{ github.event.inputs.dry_run == 'true' }}

  publish-kfp:
    if: ${{ github.event.inputs.packages == 'all' || github.event.inputs.packages == 'kfp' }}
    # Uncomment once all packages in PyPi are configured to be released from this repo.
    # needs: [publish-kfp-pipeline-spec, publish-kfp-server-api]
    uses: ./.github/workflows/publish-package-reusable.yml
    with:
      package_name: kfp
      build_dir: sdk
      dist_path: sdk/python/dist/
      build_commands: |
        make python
        cd python
        twine check dist/*
      tag: ${{ github.event.inputs.tag }}
      dry_run: ${{ github.event.inputs.dry_run == 'true' }}

  publish-kfp-kubernetes:
    if: ${{ github.event.inputs.packages == 'all' || github.event.inputs.packages == 'kfp-kubernetes' }}
    # Uncomment once all packages in PyPi are configured to be released from this repo.
    # needs: [publish-kfp-pipeline-spec, publish-kfp]
    uses: ./.github/workflows/publish-package-reusable.yml
    with:
      package_name: kfp-kubernetes
      build_dir: kubernetes_platform
      dist_path: kubernetes_platform/python/dist/
      build_commands: |
        make python
        cd python
        twine check dist/*
      tag: ${{ github.event.inputs.tag }}
      dry_run: ${{ github.event.inputs.dry_run == 'true' }}
