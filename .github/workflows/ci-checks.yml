# This workflow checks if all CI checks have passed by polling every 5 minutes for a total of 8 attempts.
name: CI Check

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

jobs:
  check_ci_status:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      checks: read
    steps:
      - name: Check out the repository
        uses: actions/checkout@v5

      - name: Check for 'needs-ok-to-test' and 'ok-to-test' labels
        id: label_check
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'needs-ok-to-test') }}" == "true" ]]; then
            echo "Label 'needs-ok-to-test' found. Skipping the workflow."
            exit 0
          fi
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'ok-to-test') }}" == "true" ]]; then
            echo "Label 'ok-to-test' found. Continuing the workflow."
          else
            echo "Label 'ok-to-test' not found. Skipping the workflow."
            exit 0
          fi

      - name: Check if all CI checks passed
        uses: wechuli/allcheckspassed@0b68b3b7d92e595bcbdea0c860d05605720cf479
        with:
          commit_sha: ${{ github.event.pull_request.head.sha }}
          delay: '5'
          retries: '10'
          polling_interval: '5'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Verify fresh frontend e2e run for latest PR SHA
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;
            const workflowId = '.github/workflows/e2e-test-frontend.yml';
            const maxAttempts = 30;
            const pollingIntervalMs = 30 * 1000;

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            core.info(
              `Checking workflow ${workflowId} for PR #${prNumber} at SHA ${headSha}.`,
            );

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const runs = await github.paginate(
                'GET /repos/{owner}/{repo}/actions/workflows/{workflow_id}/runs',
                {
                  owner,
                  repo,
                  workflow_id: workflowId,
                  event: 'pull_request',
                  head_sha: headSha,
                  per_page: 100,
                },
              );

              const matchingRuns = runs
                .filter(run => {
                  const pullRequests = Array.isArray(run.pull_requests)
                    ? run.pull_requests
                    : [];
                  return pullRequests.some(pr => pr.number === prNumber);
                })
                .sort(
                  (a, b) => Date.parse(b.created_at) - Date.parse(a.created_at),
                );

              if (matchingRuns.length === 0) {
                core.info(
                  `[${attempt}/${maxAttempts}] No pull_request run found yet for workflow ${workflowId} at SHA ${headSha}.`,
                );
              } else {
                const latestRun = matchingRuns[0];
                core.info(
                  `[${attempt}/${maxAttempts}] Latest run ${latestRun.id}: status=${latestRun.status}, conclusion=${latestRun.conclusion || 'null'}, url=${latestRun.html_url}`,
                );

                if (latestRun.status === 'completed') {
                  if (latestRun.conclusion === 'success') {
                    core.info(
                      `Verified fresh successful frontend e2e run: ${latestRun.html_url}`,
                    );
                    return;
                  }

                  core.setFailed(
                    `Latest frontend e2e pull_request run for SHA ${headSha} failed with conclusion=${latestRun.conclusion}. ${latestRun.html_url}`,
                  );
                  return;
                }
              }

              if (attempt < maxAttempts) {
                await sleep(pollingIntervalMs);
              }
            }

            core.setFailed(
              `Timed out waiting for a completed successful frontend e2e pull_request run for SHA ${headSha}.`,
            );
      - name: Save PR payload
        shell: bash
        run: |
          mkdir -p ./pr
          echo ${{ github.event.pull_request.number }} >> ./pr/pr_number
          echo ${{ github.event.action }} >> ./pr/event_action
      - uses: actions/upload-artifact@v4
        with:
          name: pr
          path: pr/
