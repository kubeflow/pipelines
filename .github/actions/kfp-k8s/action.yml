name: "Install kfp & kfp-kubernetes"
description: "Install kfp & kfp-kubernetes"
inputs:
  build_version:
    required: true
    default: "1.3.0"
    description: "build package version"
  generate_golang_proto:
    required: true
    default: "false"
    description: "optionally generate golang proto files"
runs:
  using: "composite"
  steps:
    - name: Setup uv
      shell: bash
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Build & install kfp-server-api dist
      id: install-kfp-server-api
      shell: bash
      working-directory: backend/api/v2beta1/python_http_client
      run: |
        rm -rf dist/
        uv build
        shopt -s nullglob
        wheels=(dist/*.whl)
        uv pip install --system "${wheels[@]}"

    - name: Build kfp dist
      id: install-kfp
      shell: bash
      working-directory: sdk/python
      run: |
        rm -rf dist/
        uv build
        shopt -s nullglob
        wheels=(dist/*.whl)
        uv pip install --system "${wheels[@]}"

    - name: Generate kfp-kubernetes python proto files from source
      id: generate-kfp-kubernetes-proto-files
      shell: bash
      if: ${{ steps.install-kfp.outcome == 'success' && steps.install-kfp-server-api.outcome == 'success'  }}
      working-directory: ./kubernetes_platform
      run: make clean python USE_FIND_LINKS=true

    - name: Generate kfp-kubernetes golang proto files from source
      id: generate-kfp-kubernetes-go-proto-files
      shell: bash
      if: ${{ steps.install-kfp.outcome == 'success' && steps.install-kfp-server-api.outcome == 'success'  && inputs.generate_golang_proto == 'true' }}
      working-directory: ./kubernetes_platform
      run: make golang

    # kfp is installed transitively
    # --find-links ensures uv first looks in the sdk/python/dist folder
    # outputted from generate-kfp-kubernetes-proto-files step before looking at pypi
    - name: Install kfp & kfp-kubernetes from source
      id: install-kfp-kubernetes
      shell: bash
      if: ${{ steps.generate-kfp-kubernetes-proto-files.outcome == 'success' }}
      run: |
        uv pip install --system -e ./kubernetes_platform/python[dev] --find-links=sdk/python/dist

    # testing reinstalling kfp package from source with no deps
    - name: Reinstall kfp from source with no deps
      id: reinstall-kfp
      shell: bash
      if: ${{ steps.install-kfp-kubernetes.outcome == 'success' }}
      working-directory: ./sdk/python
      run: |
        uv pip install --system . -I --no-deps