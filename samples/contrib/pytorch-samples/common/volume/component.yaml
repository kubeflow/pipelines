name: Create PersistentVolumeClaim in Kubernetes
inputs:
- {name: PVC Name,         type: String}
- {name: Storage size, type: String, default: 1Gi}
- {name: Namespace, type: string}
outputs:
- {name: Output Name,         type: String}
metadata:
  annotations:
    author: Alexey Volkov <alexey.volkov@ark-kun.com>
implementation:
  container:
    image: bitnami/kubectl:1.17.17
    command:
    - bash
    - -exc
    - |
      pvc_name=$0
      storage_size=$1
      output_name=$2
      namespace=$3
      mkdir -p "$(dirname "$output_name")"
      object_path=$(mktemp)

      cat <<EOF >"$object_path"
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: $pvc_name
        annotations:
          volume.beta.kubernetes.io/storage-class: aws-efs
      spec:
        storageClassName: aws-efs
        accessModes:
        - ReadWriteMany
        resources:
          requests:
            storage: $storage_size
      EOF
      object_name=$(kubectl apply -f "$object_path" --namespace $namespace --output=name)
      object_name=${object_name##persistentvolumeclaim/}
      echo $object_name > $output_name

    - {inputValue: PVC Name}
    - {inputValue: Storage size}
    - {outputPath: Output Name}
    - {inputValue: Namespace}
