apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: xgboost-newsgroup-evaluation-
spec:
  entrypoint: xgboost-newsgroup-evaluation
  arguments:
    parameters:
    - name: project # GCP project to run dataproc cluster
    - name: region # region to run the dataproc cluster
      value: us-central1
    - name: cluster # cluster name to use
    - name: output # GCS path of output directory
    - name: eval # GCS path of eval csv
      value: gs://ml-pipeline-playground/newsgroup/eval.csv
    - name: model # GCS path of the model file
      value: gs://ml-pipeline-playground/newsgroup/model/model
    - name: target # which column to use as prediction target
      value: news_label
    - name: package # GCS path of distributed xgboost training package
      value: gs://ml-pipeline-playground/xgboost4j-example-0.8-SNAPSHOT-jar-with-dependencies.jar
    - name: trueclass
      value: talk.politics.mideast
    - name: analysis
      value: gs://ml-pipeline-playground/newsgroup/analysis/
  templates:
  - name: xgboost-newsgroup-evaluation
    inputs:
      parameters:
      - name: project
      - name: region
      - name: cluster
      - name: output
      - name: eval
      - name: model
      - name: target
      - name: package
      - name: trueclass
      - name: analysis
    steps:
    - - name: transform
        template: transform
        arguments:
          parameters:
          - name: project
            value: "{{inputs.parameters.project}}"
          - name: region
            value: "{{inputs.parameters.region}}"
          - name: cluster
            value: "{{inputs.parameters.cluster}}"
          - name: output
            value: "{{inputs.parameters.output}}/{{workflow.name}}/transform"
          - name: eval
            value: "{{inputs.parameters.eval}}"
          - name: target
            value: "{{inputs.parameters.target}}"
          - name: analysis
            value: "{{inputs.parameters.analysis}}"
    - - name: batchpredict
        template: batchpredict
        arguments:
          parameters:
          - name: project
            value: "{{inputs.parameters.project}}"
          - name: region
            value: "{{inputs.parameters.region}}"
          - name: cluster
            value: "{{inputs.parameters.cluster}}"
          - name: output
            value: "{{inputs.parameters.output}}/{{workflow.name}}/batchpredict"
          - name: eval
            value: "{{inputs.parameters.output}}/{{workflow.name}}/transform/eval/part-*"
          - name: target
            value: "{{inputs.parameters.target}}"
          - name: analysis
            value: "{{inputs.parameters.analysis}}"
          - name: package
            value: "{{inputs.parameters.package}}"
          - name: model
            value: "{{inputs.parameters.model}}"
    - - name: roc
        template: roc
        arguments:
          parameters:
          - name: output
            value: "{{inputs.parameters.output}}/{{workflow.name}}/roc"
          - name: predictions
            value: "{{inputs.parameters.output}}/{{workflow.name}}/batchpredict/part-*"
          - name: trueclass
            value: "{{inputs.parameters.trueclass}}"
      - name: confusionmatrix
        template: confusionmatrix
        arguments:
          parameters:
          - name: output
            value: "{{inputs.parameters.output}}/{{workflow.name}}/confusionmatrix"
          - name: predictions
            value: "{{inputs.parameters.output}}/{{workflow.name}}/batchpredict/part-*.csv"
          - name: analysis
            value: "{{inputs.parameters.analysis}}"
          - name: target
            value: "{{inputs.parameters.target}}"

  - name: transform
    inputs:
      parameters:
      - name: project
      - name: region
      - name: cluster
      - name: output
      - name: eval
      - name: target
      - name: analysis
    container:
      image: gcr.io/ml-pipeline/ml-pipeline-dataproc-xgboost
      command: [sh, -c]
      args: ["python /ml/transform.py --project {{inputs.parameters.project}} --region {{inputs.parameters.region}} --cluster {{inputs.parameters.cluster}} --output {{inputs.parameters.output}} --eval {{inputs.parameters.eval}} --target {{inputs.parameters.target}} --analysis {{inputs.parameters.analysis}}" ]

  - name: batchpredict
    inputs:
      parameters:
      - name: project
      - name: region
      - name: cluster
      - name: output
      - name: eval
      - name: model
      - name: target
      - name: package
      - name: analysis
    container:
      image: gcr.io/ml-pipeline/ml-pipeline-dataproc-xgboost
      command: [sh, -c]
      args: ["python /ml/predict.py --project {{inputs.parameters.project}} --region {{inputs.parameters.region}} --cluster {{inputs.parameters.cluster}} --output {{inputs.parameters.output}} --predict {{inputs.parameters.eval}} --analysis {{inputs.parameters.analysis}} --target {{inputs.parameters.target}} --model {{inputs.parameters.model}} --package {{inputs.parameters.package}} " ]

  - name: roc
    inputs:
      parameters:
      - name: output
      - name: predictions
      - name: trueclass
    container:
      image: gcr.io/ml-pipeline/ml-pipeline-local
      command: [sh, -c]
      args: ["python /ml/roc.py --output {{inputs.parameters.output}} --predictions {{inputs.parameters.predictions}} --trueclass {{inputs.parameters.trueclass}} " ]

  - name: confusionmatrix
    inputs:
      parameters:
      - name: output
      - name: analysis
      - name: predictions
      - name: target
    container:
      image: gcr.io/ml-pipeline/ml-pipeline-local
      command: [sh, -c]
      args: ["python /ml/confusion_matrix.py --output {{inputs.parameters.output}} --predictions {{inputs.parameters.predictions}} --analysis {{inputs.parameters.analysis}} --target {{inputs.parameters.target}}" ]
