syntax = "proto3";
import "artifacts.proto";

// All of the following services must comply to the RBAC of `runs` resource on that particular namespace
// For example, user can call "CreateTask" if they have the permission verb "update" on the Runs resource
// in the target namespace.
// Note: We do "update" instead of "create" for "CreateTask" because creating a "task" is an implicit update
// to its parent Run. A user that can only "create" a run should not have access to "update" for that
// the run, without explicitly having that verb.
service RunService {
  rpc CreateTask(CreateTaskRequest) returns (PipelineTaskDetail) {
    option (google.api.http) = {
      post: "/apis/v2beta1/tasks"
      body: "task"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      operation_id: "create_task"
      summary: "Creates a new task."
      tags: "RunService"
    };
  }

  rpc UpdateTask(UpdateTaskRequest) returns (PipelineTaskDetail) {
    option (google.api.http) = {
      patch: "/apis/v2beta1/tasks/{task_id}"
      body: "task"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      operation_id: "update_task"
      summary: "Updates an existing task."
      tags: "RunService"
    };
  }

  rpc GetTask(GetTaskRequest) returns (PipelineTaskDetail) {
    option (google.api.http) = {
      get: "/apis/v2beta1/tasks/{task_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      operation_id: "get_task"
      summary: "Gets a specific task by ID."
      tags: "RunService"
    };
  }

  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse) {
    option (google.api.http) = {
      get: "/apis/v2beta1/tasks"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      operation_id: "list_tasks"
      summary: "Lists tasks with optional filtering."
      tags: "RunService"
    };
  }
}

message CreateTaskRequest {
  PipelineTaskDetail task = 1;
}

message UpdateTaskRequest {
  string task_id = 1;
  PipelineTaskDetail task = 2;
}

message GetTaskRequest {
  string task_id = 1;
}

message ListTasksRequest {
  // Required. Must specify either parent_id or run_id to filter tasks.
  oneof parent_filter {
    // List all tasks with this parent task.
    string parent_id = 1;
    // List all tasks for this run.
    string run_id = 2;
  }

  int32 page_size = 3;
  string page_token = 4;
  string filter = 5;
  string order_by = 6;
}

message ListTasksResponse {
  repeated PipelineTaskDetail tasks = 1;
  string next_page_token = 2;
  int32 total_size = 3;
}

// Runtime information of a task execution.
message PipelineTaskDetail {
  string name = 1;
  // User specified name of a task that is defined in
  // [Pipeline.spec][].
  string display_name = 2;

  // System-generated ID of a task.
  string task_id = 3;

  // ID of the parent run.
  string run_id = 4;

  // Name of the corresponding pod assigned by the orchestration engine.
  // Also known as node_id.
  enum TaskPodType {
    UNSPECIFIED = 0;
    DRIVER = 1;
    EXECUTOR = 2;
  }
  message TaskPod {
    string name = 1;
    string uid = 2;
    TaskPodType type = 3;
  }
  repeated TaskPod pods = 5;

  string cache_fingerprint = 6;

  // Creation time of a task.
  google.protobuf.Timestamp create_time = 7;

  // Starting time of a task.
  google.protobuf.Timestamp start_time = 8;

  // Completion time of a task.
  google.protobuf.Timestamp end_time = 9;

  // Runtime state of a Task
  enum TaskState {
    // Default value. This value is not used.
    RUNTIME_STATE_UNSPECIFIED = 0;

    // Entity execution is in progress.
    RUNNING = 1;

    // Entity completed successfully.
    SUCCEEDED = 2;

    // Entity has been skipped. For example, due to caching.
    SKIPPED = 3;

    // Entity execution has failed.
    FAILED = 4;

    CACHED = 5;
  }
  TaskState state = 10;


  message StatusMetadata {
    // KFP Backend will populate this field with error messages
    // if any are available on a Failed task.
    string message = 1;
    // Custom status metadata, this can be used to provide
    // additional status info for a given task during runtime
    // This is currently not utilized by KFP backend.
    map<string, google.protobuf.Value> custom_properties = 2;
  }
  StatusMetadata status_metadata = 11;

  // Timestamped representation of a Task state with an optional error.
  message TaskStatus {
    google.protobuf.Timestamp update_time = 1;
    TaskState state = 2;
    google.rpc.Status error = 3;
  }

  // A sequence of task statuses. This field keeps a record
  // of state transitions.
  repeated TaskStatus state_history = 12;

  enum TaskType {
    // Root task replaces Root Execution, it is the top ancestor task to all tasks in the pipeline run
    ROOT = 0;
    RUNTIME = 1;
    // Condition Branch is the wrapper If block
    CONDITION_BRANCH = 2;
    // Condition is an individual if branch (this feels counter intuitive but this is how it's named in the SDK IR)
    // and we are consistent with the naming here.
    CONDITION = 3;
    // Task Group for Condition Branches
    // Task Group for Loop Iterations
    LOOP = 4;
    EXIT_HANDLER = 5;
    IMPORTER = 6;
    // Generic DAG task type for types like Nested Pipelines
    // where there is no declarative way to detect this within
    // a driver.
    DAG = 7;
  }
  TaskType type = 13;

  message TypeAttributes {
    // Optional. Applies to type Runtime that is an iteration
    optional int64 iteration_index = 1;
    // Optional. Applies to type LOOP
    optional int64 iteration_count = 2;
  }

  TypeAttributes type_attributes = 14;

  // The error that occurred during task execution.
  // Only populated when the task is in FAILED or CANCELED state.
  google.rpc.Status error = 15;

  // ID of the parent task if the task is within a component scope.
  // Empty if the task is at the root level.
  optional string parent_task_id = 16;

  // A dependent task that requires this one to succeed.
  // Represented by either task_id or pod_name.
  // TODO(HumairAK): Do we need this if we have parent_task_id?
  message ChildTask {
    // System-generated ID of a task.
    string task_id = 1;
    string name = 2;
  }

  // Sequence of dependent tasks.
  repeated ChildTask child_tasks = 17;

  message InputOutputs {
    message IOParameter {
      google.protobuf.Value value = 1;
      IOType type = 2;
      string parameter_key = 3;
      // This field is optional because in the case of
      // Input RuntimeValues, ComponentDefaultInputs,
      // and Raw Iterator Input there are no producers.
      optional IOProducer producer = 4;
    }

    // Align structure with Executor Input
    message IOArtifact {
      repeated Artifact artifacts = 1;
      IOType type = 2;
      string artifact_key = 3;
      IOProducer producer = 4;
    }
    // For Loops parameters are filled with resolved
    // parameterIterator.items
    repeated IOParameter parameters = 1;

    // Output Only. To create Artifacts for a task use
    // ArtifactTasks to link artifacts to tasks.
    repeated IOArtifact artifacts = 2;
  }
  InputOutputs inputs = 18;
  InputOutputs outputs = 19;

  // The scope of this task within the
  // pipeline spec. Each entry represents
  // either a Dag Task or a Container task.
  // Note that Container task will are
  // always the last entry in a scope_path.
  repeated string scope_path = 20;
}


message Run {
  // ...
  // This will be added
  // output only
  string pipeline_id = 18;
  // output only
  string pipeline_version_id = 19;
  repeated PipelineTaskDetail tasks = 20;

  // Either remove or deprecate this
  RunDetails run_details = 15;
}
