# Authorization policy for KFP services in STRICT mTLS mode
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: kfp-services-authz
  namespace: kubeflow
spec:
  action: ALLOW
  rules:
    # Allow all traffic from within the namespace
    - from:
        - source:
            namespaces: ["kubeflow"]
    # Allow traffic from driver pods (with proper labels)
    - from:
        - source:
            principals: ["cluster.local/ns/kubeflow/sa/*"]
      when:
        - key: source.labels[app.kubernetes.io/component]
          values: ["kfp-driver"]
    # Allow traffic from KFP components
    - from:
        - source:
            principals:
              - "cluster.local/ns/kubeflow/sa/ml-pipeline"
              - "cluster.local/ns/kubeflow/sa/ml-pipeline-ui"
              - "cluster.local/ns/kubeflow/sa/ml-pipeline-persistenceagent"
              - "cluster.local/ns/kubeflow/sa/ml-pipeline-scheduledworkflow"
              - "cluster.local/ns/kubeflow/sa/ml-pipeline-viewer-crd-service-account"
              - "cluster.local/ns/kubeflow/sa/pipeline-runner"