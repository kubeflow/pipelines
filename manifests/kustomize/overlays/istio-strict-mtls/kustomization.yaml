# Istio STRICT mTLS overlay for Kubeflow Pipelines
# This overlay configures driver pods to work with Istio service mesh in STRICT mTLS mode
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
  - ../../base

namespace: kubeflow

# Override driver configuration for Istio
configMapGenerator:
  - name: kfp-driver-config
    behavior: replace
    literals:
      - |
        driver-config={
          "labels": {
            "sidecar.istio.io/inject": "true",
            "app.kubernetes.io/component": "kfp-driver"
          },
          "annotations": {
            "proxy.istio.io/config": "{\"holdApplicationUntilProxyStarts\": true}",
            "traffic.sidecar.istio.io/includeInboundPorts": "*",
            "traffic.sidecar.istio.io/excludeOutboundPorts": "15090,15021"
          }
        }
      - driverResourceLimitsCpu=1000m
      - driverResourceLimitsMemory=1Gi
      - driverResourceRequestsCpu=200m
      - driverResourceRequestsMemory=256Mi
    options:
      disableNameSuffixHash: true

# Patch API server deployment for Istio-specific environment variables
patchesStrategicMerge:
  - ml-pipeline-apiserver-patch.yaml

# Add Istio security policies
resources:
  - peerauthentication.yaml
  - authorizationpolicy.yaml