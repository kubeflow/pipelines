apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base/installs/generic
  - ../../base/metadata/base
  - ../../third-party/argo/installs/namespace
  - ../../third-party/seaweedfs/base
  - ../../third-party/postgresql/base
  - ./forward-local-api-endpoint.yaml

patches:
  - path: mlmd-patch.yaml
  # UI NodePort
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: ml-pipeline-ui
        namespace: kubeflow
      spec:
        ports:
          - $patch: replace
          - name: http
            port: 80
            protocol: TCP
            targetPort: 3000
            nodePort: 30300
        type: NodePort
  # PostgreSQL NodePort
  - patch: |-
      - op: replace
        path: /spec/type
        value: NodePort
      - op: add
        path: /spec/ports/0/nodePort
        value: 30432
    target:
      kind: Service
      name: postgres-service
  # MLMD NodePort
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: metadata-grpc-service
        namespace: kubeflow
      spec:
        ports:
          - $patch: replace
          - port: 8080
            protocol: TCP
            targetPort: 8080
            nodePort: 30808
        type: NodePort
  # MinIO NodePort
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: minio-service
        namespace: kubeflow
      spec:
        ports:
          - $patch: replace
          - port: 9000
            protocol: TCP
            targetPort: 8333
            nodePort: 30900
        type: NodePort
  # Visualization Server NodePort
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: ml-pipeline-visualizationserver
        namespace: kubeflow
      spec:
        ports:
          - $patch: replace
          - port: 8888
            protocol: TCP
            targetPort: 8888
            nodePort: 30889
        type: NodePort
  # ml-pipeline deployment - set replicas to 0 (run locally)
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ml-pipeline
        namespace: kubeflow
      spec:
        replicas: 0
  # ml-pipeline service - remove selector for external endpoint
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: ml-pipeline
        namespace: kubeflow
      spec:
        selector:
          $patch: delete
  # ml-pipeline-ui environment variables
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ml-pipeline-ui
        namespace: kubeflow
      spec:
        template:
          spec:
            containers:
              - name: ml-pipeline-ui
                env:
                  - name: ML_PIPELINE_SERVICE_HOST
                    value: ml-pipeline
                  - name: ML_PIPELINE_SERVICE_PORT
                    value: "8888"
                  - name: DISABLE_GKE_METADATA
                    value: "true"
  # NetworkPolicy - allow external access to services
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: default-allow-same-namespace
        namespace: kubeflow
      spec:
        podSelector: {}
        ingress:
        - from:
          - podSelector: {}
        - from:
          - ipBlock:
              cidr: 0.0.0.0/0
          ports:
          - port: 3000
            protocol: TCP
          - port: 5432
            protocol: TCP
          - port: 8080
            protocol: TCP
          - port: 9000
            protocol: TCP
          - port: 8888
            protocol: TCP
        policyTypes:
        - Ingress
  # SeaweedFS NetworkPolicy
  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: seaweedfs
        namespace: kubeflow
      spec:
        ingress:
        - from:
          - namespaceSelector:
              matchExpressions:
              - key: app.kubernetes.io/part-of
                operator: In
                values:
                - kubeflow-profile
          ports:
          - port: 8333
        - from:
          - namespaceSelector:
              matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                - istio-system
        - from:
          - ipBlock:
              cidr: 0.0.0.0/0
          ports:
          - port: 8333
        podSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - seaweedfs
        policyTypes:
        - Ingress

configMapGenerator:
  - name: pipeline-install-config
    behavior: merge
    literals:
      - DBDriverName=pgx
      - pipelineDb=mlpipeline
      - cacheDb=cachedb
      - postgresHost=postgres-service
      - postgresPort=5432

# !!! If you want to customize the namespace,
# please also update base/cache-deployer/cluster-scoped/cache-deployer-clusterrolebinding.yaml
namespace: kubeflow

# Identifier for application manager to apply ownerReference.
# The ownerReference ensures the resources get garbage collected
# when application is deleted.
labels:
  - includeSelectors: false
    pairs:
      application-crd-id: kubeflow-pipelines
