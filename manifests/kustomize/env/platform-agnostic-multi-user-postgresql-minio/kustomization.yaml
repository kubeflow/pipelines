apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Multi-user + PostgreSQL + MinIO configuration
# This configuration uses PostgreSQL database with MinIO storage in multi-user mode
resources:
  - ../../third-party/metacontroller/base
  - ../../base/installs/multi-user
  - ../../base/metadata/base
  - ../../base/metadata/options/istio
  - ../../third-party/argo/installs/cluster
  - ../../third-party/postgresql/base
  - ../../third-party/minio/base
  - ../../third-party/minio/options/istio

patches:
  - path: apiserver-patch.yaml
  - path: cache-server-patch.yaml
  - path: mlmd-patch.yaml
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: kubeflow-pipelines-profile-controller
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: kubeflow-pipelines-profile-controller
      spec:
        template:
          spec:
            containers:
            - name: profile-controller
              env:
              - name: MINIO_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: mlpipeline-minio-artifact
                    key: accesskey
              - name: MINIO_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: mlpipeline-minio-artifact
                    key: secretkey
              - name: AWS_ENDPOINT_URL
                value: http://minio-service.kubeflow:9000
              - name: S3_ENDPOINT_URL
                value: http://minio-service.kubeflow:9000
  - target:
      group: ""
      version: v1
      kind: ConfigMap
      name: pipeline-install-config
    patch: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: pipeline-install-config
      data:
        defaultPipelineRoot: minio://mlpipeline/v2/artifacts

configMapGenerator:
  - name: pipeline-install-config
    behavior: merge
    literals:
      - DBDriverName=pgx
      - pipelineDb=mlpipeline
      - cacheDb=cachedb
      - postgresHost=postgres-service
      - postgresPort=5432
  - name: kubeflow-pipelines-profile-controller-code
    behavior: replace
    files:
      # swap sync.py with minio compatible sync.py
      - sync.py=sync.py

# !!! If you want to customize the namespace,
# please also update base/cache-deployer/cluster-scoped/cache-deployer-clusterrolebinding.yaml
namespace: kubeflow

# Identifier for application manager to apply ownerReference.
# The ownerReference ensures the resources get garbage collected
# when application is deleted.
labels:
  - includeSelectors: true
    pairs:
      application-crd-id: kubeflow-pipelines
